<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pago con Stripe</title>
  <script src="https://js.stripe.com/v3/"></script>
</head>

<body style="background:#111; color:white; font-family:sans-serif; padding:40px;">
  <h2>Pago en Stripe</h2>

  <button id="btnPagar">Pagar $200 MXN</button>

  <div id="card-element" style="margin-top:20px;"></div>
  <div id="mensaje" style="margin-top:20px;"></div>

  <!-- Script con type="module" para permitir await -->
  <script type="module">

    //  Cargar configuración desde el backend (clave pública + URL API)
    async function cargarConfig() {
      const conf = await fetch("https://back-xde2.onrender.com").then(r => r.json());
      window.STRIPE_PUBLIC_KEY = conf.stripePublicKey;
      window.API_URL = conf.apiUrl;
      console.log("Config cargada:", conf);
    }

    // Esperamos que se cargue antes de continuar
    await cargarConfig();

    // >>> Inicializar Stripe con la clave pública cargada dinámicamente
    const stripe = Stripe(window.STRIPE_PUBLIC_KEY);

    let card = null;

    async function iniciarStripe() {
      const elements = stripe.elements();
      card = elements.create("card");
      card.mount("#card-element");
    }

    // Montar card-element (elemento creado en un div)
    await iniciarStripe();

    // clic en botón de pago
    document.getElementById("btnPagar").addEventListener("click", async () => {
      document.getElementById("mensaje").innerHTML = "Procesando...";

      // Crear PaymentIntent desde el backend (llamando a la API)
      const res = await fetch(window.API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          monto: 20000,      // $200 MXN
          moneda: "mxn",
          descripcion: "Compra en tienda"
        })
      });

      const data = await res.json();
      const clientSecret = data.clientSecret;

      // Confirmar pago en Stripe
      const result = await stripe.confirmCardPayment(clientSecret, {
        payment_method: {
          card: card
        }
      });

      // Validar resultado
      if (result.error) {
        document.getElementById("mensaje").innerHTML =
          "Error en el pago: " + result.error.message;
      } else if (result.paymentIntent.status === "succeeded") {
        document.getElementById("mensaje").innerHTML =
          "Pago exitoso<br>ID: " + result.paymentIntent.id;
      }
    });

  </script>
</body>
</html>
